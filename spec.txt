===============================
Currently Outstanding Dev Specs
===============================
CRITICAL
bl_review_templater.php - add aggregate review snippet HTML!!! Math works!


bl_review_monster.php
                                - COMPLETED! 6.15.2020 - method for weighted average of all locales & directories
                                - CRITICAL - method for associating metas & taxa with post id for full active record!!!!
                                  TO DO - eventually . . .
                                - for weighted average by locale or directory
                                - for aggregate review shortcode handler (see also bl_review_templater.php, line 35)
                       - line 39
                                - methods filtering the collection of all reviews:
                                - by rating!
                                - by locale?
                                - by date range?

bl_client_tasker.php - line 144
                                - COMPLETED! 6.16.2020 - add database cleanup task for activity log!

                                  TO DO
                                - add validation for API Keys?

bl_scraper.php - lines 295-325   CRITICAL - COMPLETED 6.19.2020
                                 retool database commit for crs_review post type
                                - UPDATE - all reviews now commit to a single table with
                                           a 'listing-directory' property of google or
                                           facebook to identify them 6.15.2020

                                  COMPLETED! 6.8.2020
                                - IMPORTANT - run tests to ensure locale IDs are working
admin -
                                  COMPLETED! 6.15.2020
                                - add manual deployment by locale by directory
                                  COMPLETED! 6.15.2020
                                - add toggle between manual and auto
=========================
  WHAT'S THE BIG IDEA?
=========================
  Build the data backlog prior to plugin upload using baby-lambda csv export.
  Plugin activation writes the csv to the database.
  The API call tasks maintain database updates at periodic intervals.

  TO DO
  - add 'build' script to baby-lambda to iterate raw review properties and add
    needed meta-values of locale ID and directory (currently in filenames)
  - Roll baby-lambda into the plugin and point the main script at its dependencies - DONE!
  - add custom NAP REST endpoint in the plugin so baby-lambda can call the site
    by key=>val pairs of client-name=>url on the CIS and get valid NAPs for its API calls.
  - point CSV upload routine at baby-lambda's exported CSV files to post the
     review backlogs using raw SQL operations in an expanded activtion hook
================================================================================

CRITICAL - COMPLETED!!!
DATA Structure Revisions Needed! Use CRS Reviews Custom Post type!
Reviews need to be stored as posts in the database with custom taxa and metas
Using these terms:

       /suite/admin/class-review-init.php to register custom post type
       /suite/damin/class-php-review-importer.php to get them into the database

       -- see BL_Init_Review_Post and main file, lines 228-290

       add_action( 'init', array( 'CRSReviewInit', 'review_custom_post_type' ) );
       add_action( 'init', array( 'CRSReviewInit', 'crs_review_star_tax' ) );
       add_action( 'init', array( 'CRSReviewInit', 'crs_review_star_numbers' ) );

       Need to add meta key values for author_avatar, listing_directory, locale_id,
         timestamp, and id in the database

      Currently they are stored as an array in options->'bl_api_client_activity'['reviews']

      The database commit action is currently at the bottom of BL_Scraper::call_local_dir()
      Aggregate reviews arrays should still commit to the options table for easy updates & access
      They are a fixed size and won't take up space

WHY IS wp_insert_post() CRASHING THE SITE? - MANAGED!!! 6.19.2020 using $wpdb->insert();

test custom review post bl-api-client.php lines 244-286
Custom Post Routine in Wordpress is throwing untraceable errors:
[18-Jun-2020 23:19:02 UTC] PHP Notice:  Trying to get property 'feeds' of non-object in /nas/content/live/anderstage/wp-includes/post.php on line 4370
[18-Jun-2020 23:19:02 UTC] PHP Notice:  wp_insert_post was called <strong>incorrectly</strong>. Invalid taxonomy: rating. Please see <a href="https://wordpress.org/support/article/debugging-in-wordpress/">Debugging in WordPress</a> for more information. (This message was added in version 4.4.0.) in /nas/content/live/anderstage/wp-includes/functions.php on line 5167
[18-Jun-2020 23:19:02 UTC] PHP Notice:  Trying to get property 'use_trailing_slashes' of non-object in /nas/content/live/anderstage/wp-includes/link-template.php on line 49
[18-Jun-2020 23:19:02 UTC] PHP Fatal error:  Uncaught Error: Call to undefined function is_user_logged_in() in /nas/content/live/anderstage/wp-includes/post.php:2591
Stack trace:
#0 /nas/content/live/anderstage/wp-includes/post.php(6802): _count_posts_cache_key('crs_review', 'readable')
#1 /nas/content/live/anderstage/wp-includes/class-wp-hook.php(287): _transition_post_status('publish', 'new', Object(WP_Post))
#2 /nas/content/live/anderstage/wp-includes/class-wp-hook.php(311): WP_Hook->apply_filters('', Array)
#3 /nas/content/live/anderstage/wp-includes/plugin.php(478): WP_Hook->do_action(Array)
#4 /nas/content/live/anderstage/wp-includes/post.php(4667): do_action('transition_post...', 'publish', 'new', Object(WP_Post))
#5 /nas/content/live/anderstage/wp-includes/post.php(4054): wp_transition_post_status('publish', 'new', Object(WP_Post))
#6 /nas/content/live/anderstage/wp-content/plugins/bl-api-client/bl-api-client.php(288): wp_insert_post(Array)
#7 /nas/content/live/anderstage/wp-settings.php(371): include_once('/nas/content/li...')
#8 /nas/content/l in /nas/content/live/anderstage/wp-includes/post.php on line 2591


MANAGED?
Server execution timeout problem - summary;
  Default API Call is for the first 100 reviews; can pull up to 500 in one 'page' if
  set to 'all', but approaching 100 review range is where the server execution
  timeout limit seems to occur quite consistently.
  COMPLETED 6.15.2020:
  We can eliminate these occasions by limiting the size of the API call.
  Since the update tasks are time based, it makes sense to set a small lookback
  window of time and run the importer that often for that previous period.
  Updated 6.16.2020:
  That also means we need a way to get the old reviews into the database -
  The Serverless CLI tool Baby-Lambda exports JSON & CSV files per API call,
  runs pagination operations to get all the reviews, and is faster than WordPress.


public static function crsuite_agg_review_shortcode( $atts ) {
       $a = shortcode_atts( array(
           'title' => 'Our Reviews'
         ), $atts );
       $home = site_url();
       // Set the Return Variable
       $crsuite_agg = '';
       // CR Suite Options
       $crs_options = get_option('cr_suite_options');
       // CRS Business Options
       $biz_options = get_option('crs_business_options');
       // Geoblock Options
       $geoblock_options = get_option( 'og_geo_options' );
       // get_terms - Here we are pulling all the 'rating' post types with the 5, 4 or 3 rating. ( object ) and putting it into the var $terms
       // $terms = get_transient( 'cr_reviews' );



       if ('' != $biz_options) {
         $button_one = isset($geoblock_options['og_geo_button_text_one']) ?  $geoblock_options['og_geo_button_text_one'] : '';
         $button_one_link = isset($geoblock_options['og_geo_button_link_one']) ?  $geoblock_options['og_geo_button_link_one'] : '';
         $button_two = isset($geoblock_options['og_geo_button_text_two']) ?  $geoblock_options['og_geo_button_text_two'] : '';
         $button_two_link = isset($geoblock_options['og_geo_button_link_two']) ?  $geoblock_options['og_geo_button_link_two'] : '';

         $review_override_bool = $crs_options['cr_review_override_bool'] ?? '';
         $review_override_rating = $crs_options['cr_review_override_rating'] ?? '';
         $main_service = isset( $biz_options['business_service'] ) ? $biz_options['business_service'] : '';
         $business_name = isset( $biz_options['business_name']) ? $biz_options['business_name'] : '';
         $business_service = isset( $biz_options['business_service']) ? $biz_options['business_service'] : '';

         // if ( false === $terms ) {
           $terms = get_terms( array(
               'taxonomy' => 'rating',
               'hide_empty' => false,
               'name'				=>	[
                 '5 Stars',
                 '4 Stars',
                 '3 Stars'
                 ]
           ) );
           // set_transient( 'cr_reviews', $terms, 3600 );
         // }

         foreach ($terms as $k => $v) {
            // switch - Load the COUNT of each review category

            switch ($v->name) {
              case '3 Stars':
                $three_stars = $v->count;
                break;
              case '4 Stars':
                $four_stars = $v->count;
                break;
              case '5 Stars':
                $five_stars = $v->count;
                break;
              default:
                # code...
                break;
            }
          }
          // We will total the amount of FOUND REVIEWS and put in the var $total_reviews
          $total_reviews = $five_stars + $four_stars + $three_stars;
          // find the aggregate review rating and put in the var $agg_review
          if (false == $review_override_bool) {
             $unround_agg = ( 5 * $five_stars + 4 * $four_stars + 3 * $three_stars ) / ( $total_reviews );
             if ( is_nan($unround_agg)) {
               $agg_review = 0;
             } else {
               $agg_review = round($unround_agg, 1);
             }
             $percentRating = $agg_review * 20;
          }
          $agg_class = '';
          $load_scripts_result = CrsUtility::crs_application_permission_settings('crs_geoblock');
          if( CRSReviewTemplate::isMobileDevice() || CRSReviewTemplate::isBot() ) {
            $agg_class = 'class="hreview-aggregate"';
          }

          $crsuite_agg .= '<h3 class="card-title">' . $a['title'] . '</h3>';
          $crsuite_agg .= '<div id="cr-review-blockx" ' . $agg_class .'>';
          $crsuite_agg .= '<b class="item"><span class="fn">'. $business_name . '</span></b>';
          $crsuite_agg .= '<div>';
          $crsuite_agg .= '<div class="rating-container">';
          $crsuite_agg .= '<div class="r-stars">';
          $crsuite_agg .= '<div class="r-stars-inner" style="width: ' . $percentRating . '%; background: transparent url( \'' . $home . '/wp-content/plugins/a-city-ranked-suite/suite/review/assets/gold-star.png\' ) repeat-x 0 0;background-position: 0 -25px;"> ';
          $crsuite_agg .= '</div><div>';
          $crsuite_agg .= '<p class="aggRatings">Rated <span class="rating">' . $agg_review . '</span>/<span>5</span> Based on <span class="count">' . $total_reviews . '</span> Verified Ratings</p>';
          $crsuite_agg .= ( 1 == $load_scripts_result ) ? '<p><a class="aggReview-button" href="' . $button_one_link . '">' . $button_one . '</a><br>' : '';
          $crsuite_agg .= ( 1 == $load_scripts_result ) ? '<a class="aggReview-button" href="' . $button_two_link . '">' . $button_two . '</a></p>' : '';
          $crsuite_agg .= '</div></div></div></div></div></div>';
       }

       echo $crsuite_agg;
     }


bl_review_monster.php - line 34
CRITICAL - COMPLETED 6.19.2020!!!
DATA Structure Revisions Needed! Use CRS Reviews Custom Post type
Reviews need to be stored as posts in the database with custom taxa and metas

ACTIVE RECORD OF DATA SCHEMA WILL HAVE TO BE REWRITTEN!COMPLETED 6.16.2020!
Review Monster has a $monster->reviews property with required sub-properties,
including 'listing_directory' of either google or facebook.
 - see constructor function lines 17-22
